<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Moja apka</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#000000">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial; max-width: 400px; margin: auto; padding: 20px; }
    label { display: block; margin-top: 15px; }
    input, select { width: 100%; padding: 8px; margin-top: 5px; }
    button { margin-top: 20px; padding: 10px; width: 100%; font-weight: bold; cursor: pointer; }
    span.value { font-weight: bold; }
  </style>
</head>

<body>
  <h2>Wprowadź dane do dowodu</h2>

  <input id="imie" placeholder="Imię">
  <input id="nazwisko" placeholder="Nazwisko">
  <input id="birthdate" type="date" placeholder="Data urodzenia">
  <input id="pesel" placeholder="PESEL">
  <input id="ojciec" placeholder="Imię ojca">
  <input id="matka" placeholder="Imię matki">
  <input id="miejsce" placeholder="Miejsce urodzenia">
  <input id="adres1" placeholder="Ulica i nr domu">
  <input id="adres2" placeholder="Kod i miejscowość">
  <input id="dataZameldowania" type="date" placeholder="Data zameldowania">
  
  <label>Zdjęcie: </label>
  <input type="file" id="zdjecie" accept="image/*">

  <button id="zapisz">Zapisz i pokaż dowód</button>
  <script>
    // helper: generate roleplay PESEL (simplified, not real-identical)
    function generatePesel(dateStr, gender) {
      if (!dateStr || !gender) return '';
      const d = new Date(dateStr);
      if (isNaN(d)) return '';
      let year = d.getFullYear();
      let yy = String(year).slice(-2);
      let mm = d.getMonth() + 1; // 1-12
      let dd = d.getDate();
      // handle century for PESEL style (simple): if year >=2000 add 20 to month
      if (year >= 2000) mm += 20;
      const mmStr = String(mm).padStart(2,'0');
      const ddStr = String(dd).padStart(2,'0');
      const serial = String(Math.floor(Math.random()*900)+100); // 3 digits
      let genderDigit = Math.floor(Math.random()*5)*2; // even
      if (gender === 'MĘŻCZYZNA') genderDigit += 1; // make odd
      const first10 = yy + mmStr + ddStr + serial + genderDigit;
      const weights = [1,3,7,9,1,3,7,9,1,3];
      let sum = 0;
      for (let i=0;i<10;i++) sum += weights[i] * Number(first10[i]);
      const checksum = (10 - (sum % 10)) % 10;
      return first10 + checksum;
    }

    // show dynamic PESEL preview when date or gender changes
    const birthInput = document.getElementById('birthdate');
    const genderInput = document.getElementById('gender');
    const peselPreview = document.getElementById('peselPreview');

    function updatePreview() {
      const p = generatePesel(birthInput.value, genderInput.value);
      peselPreview.textContent = p ? ('PESEL: ' + p) : 'PESEL: —';
    }
    birthInput.addEventListener('input', updatePreview);
    genderInput.addEventListener('change', updatePreview);

    document.getElementById('saveBtn').addEventListener('click', function(){
      // simple validation
      const imie = document.getElementById('dane1').value.trim();
      const nazwisko = document.getElementById('dane2').value.trim();
      if (!imie || !nazwisko) { alert('Wpisz imię i nazwisko'); return; }

      // set items
      localStorage.setItem('dane1', imie.toUpperCase());
      localStorage.setItem('dane2', nazwisko.toUpperCase());
      localStorage.setItem('gender', genderInput.value);
      localStorage.setItem('birthdate', birthInput.value);
      // pesel — generate now and store
      const pesel = generatePesel(birthInput.value, genderInput.value);
      if (pesel) localStorage.setItem('pesel', pesel);

      localStorage.setItem('daneOjca', document.getElementById('daneOjca').value.toUpperCase());
      localStorage.setItem('daneMatki', document.getElementById('daneMatki').value.toUpperCase());
      localStorage.setItem('miejsceUrodzenia', document.getElementById('miejsceUrodzenia').value.toUpperCase());
      const a1 = document.getElementById('adres1').value.toUpperCase();
      const a2 = document.getElementById('adres2').value.toUpperCase();
      localStorage.setItem('adres', a1 + '|' + a2);
      localStorage.setItem('dataZameldowania', document.getElementById('dataZameldowania').value);

      // save image if selected
      const file = document.getElementById('zdjecie').files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          try { localStorage.setItem('zdjecie', e.target.result); } catch(err) {
            alert('Obrazek za duży dla localStorage — zmniejsz zdjęcie.');
            console.error(err);
          }
          window.location.href = 'dowodnowy.html';
        };
        reader.readAsDataURL(file);
      } else {
        // no image selected — clear any previous image so dowod shows placeholder
        localStorage.removeItem('zdjecie');
        window.location.href = 'dowodnowy.html';
      }
    });

    // debug help: expose a function to clear storage quickly
    window.DEBUG_clearLS = () => { localStorage.clear(); alert('localStorage cleared'); };
  </script>
</body>
</html>
